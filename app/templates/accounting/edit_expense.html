{% extends "base.html" %}

{% block title %}Edit Expense - Mohi Industries ERP{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Edit Expense</h1>
        <a href="{{ url_for('accounting.list_expenses') }}"
            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition">
            ‚Üê Back
        </a>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6">
        <form method="POST" action="{{ url_for('accounting.edit_expense', id=expense.id) }}">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Expense Number (Read-only) -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Expense Number</label>
                    <input type="text" value="{{ expense.expense_number }}" readonly
                        class="w-full px-4 py-2 border border-gray-300 rounded bg-gray-100 cursor-not-allowed">
                </div>

                <!-- Expense Date -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Expense Date *</label>
                    <input type="date" name="expense_date" value="{{ expense.expense_date }}" required
                        class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Expense Account -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Expense Account *</label>
                    <select id="account_id" name="account_id" required
                        class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        {% for account in accounts %}
                        <option value="{{ account.id }}" {% if account.id==expense.account_id %}selected{% endif %}>
                            {{ account.name }} ({{ account.account_number }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Amount -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Amount (Excl. GST) *</label>
                    <input type="number" name="amount" step="0.01" value="{{ expense.amount }}" required
                        class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- GST Applicable -->
                <div class="flex items-center pt-8">
                    <input type="checkbox" name="is_gst_applicable" id="is_gst_applicable" {% if
                        expense.is_gst_applicable %}checked{% endif %} class="mr-2">
                    <label for="is_gst_applicable" class="text-sm font-semibold text-gray-700">GST Applicable</label>
                </div>

                <!-- Vendor Name -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Vendor Name</label>
                    <input type="text" name="vendor_name" value="{{ expense.vendor_name or '' }}"
                        class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Vendor GSTIN -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Vendor GSTIN</label>
                    <input type="text" name="vendor_gstin" maxlength="15" value="{{ expense.vendor_gstin or '' }}"
                        class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Invoice Number -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Invoice Number</label>
                    <input type="text" name="invoice_number" value="{{ expense.invoice_number or '' }}"
                        class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Invoice Date -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Invoice Date</label>
                    <input type="date" name="invoice_date" value="{{ expense.invoice_date or '' }}"
                        class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Payment Mode -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Mode *</label>
                    <select name="payment_mode" required
                        class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        <option value="cash" {% if expense.payment_mode=='cash' %}selected{% endif %}>Cash</option>
                        <option value="bank" {% if expense.payment_mode=='bank' %}selected{% endif %}>Bank Transfer
                        </option>
                        <option value="cheque" {% if expense.payment_mode=='cheque' %}selected{% endif %}>Cheque
                        </option>
                        <option value="upi" {% if expense.payment_mode=='upi' %}selected{% endif %}>UPI</option>
                        <option value="card" {% if expense.payment_mode=='card' %}selected{% endif %}>Card</option>
                    </select>
                </div>

                <!-- Payment Status -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Status *</label>
                    <select name="payment_status" required
                        class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        <option value="paid" {% if expense.payment_status=='paid' %}selected{% endif %}>Paid</option>
                        <option value="pending" {% if expense.payment_status=='pending' %}selected{% endif %}>Pending
                        </option>
                    </select>
                </div>

                <!-- Reference Number -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Reference Number</label>
                    <input type="text" name="reference_number" value="{{ expense.reference_number or '' }}"
                        class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Expense Category -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                    <select id="expense_category" name="expense_category"
                        class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        <option value="">Auto (Recommended)</option>
                        {% set current_cat = (expense.expense_category or '') %}
                        {% set active_names = (expense_categories or []) | map(attribute='name') | list %}
                        {% if current_cat and (current_cat not in active_names) %}
                        <option value="{{ current_cat }}" selected>{{ current_cat }} (Legacy)</option>
                        {% endif %}
                        {% for cat in expense_categories or [] %}
                        <option value="{{ cat.name }}" {% if cat.name == current_cat %}selected{% endif %}>{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Description -->
            <div class="mt-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                <textarea name="description" rows="2"
                    class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">{{ expense.description or '' }}</textarea>
            </div>

            <!-- Remarks -->
            <div class="mt-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Remarks</label>
                <textarea name="remarks" rows="2"
                    class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">{{ expense.remarks or '' }}</textarea>
            </div>

            <!-- Submit Button -->
            <div class="mt-6 flex justify-end space-x-4">
                <a href="{{ url_for('accounting.list_expenses') }}"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded transition">
                    Cancel
                </a>
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded transition">
                    Update Expense
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    (function () {
        const accountSelect = document.getElementById('account_id');
        const categorySelect = document.getElementById('expense_category');
        if (!accountSelect || !categorySelect) return;

        const mapEl = document.getElementById('account_category_map');
        const map = mapEl ? JSON.parse(mapEl.textContent || '{}') : {};

        function autoFillCategory() {
            const accountId = accountSelect.value;
            const suggested = map[String(accountId)] || '';
            const current = (categorySelect.value || '').trim();

            // Don't override existing categories when editing unless blank/General.
            if (!suggested) return;

            // Don't override existing categories when editing unless blank/General.
            if (!current || current.toLowerCase() === 'general') {
                const exists = Array.from(categorySelect.options).some(o => o.value === suggested);
                if (!exists) {
                    const opt = document.createElement('option');
                    opt.value = suggested;
                    opt.textContent = suggested;
                    categorySelect.appendChild(opt);
                }
                categorySelect.value = suggested;
            }
        }

        accountSelect.addEventListener('change', autoFillCategory);
    })();
</script>

<script type="application/json" id="account_category_map">{{ (account_category_map or {}) | tojson }}</script>
{% endblock %}