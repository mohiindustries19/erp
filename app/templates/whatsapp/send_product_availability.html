{% extends "base.html" %}

{% block title %}Send Product Availability - Mohi Industries ERP{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
            <h1 class="text-3xl font-display font-bold text-gray-900 dark:text-white">Product Availability</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-1">Send today’s available products to selected distributors</p>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('whatsapp.dashboard') }}" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">← Back</a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Selection -->
        <div class="lg:col-span-2 bg-white dark:bg-dark-surface rounded-xl shadow-soft dark:shadow-none p-6 border border-gray-100 dark:border-dark-border">
            <form method="POST" class="space-y-5">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-bold text-gray-800 dark:text-white">Select Distributors</h2>
                    <button type="button" id="toggleAll" class="text-sm text-primary-600 dark:text-primary-400 hover:underline">Select all</button>
                </div>

                <div class="max-h-[420px] overflow-auto rounded-lg border border-gray-100 dark:border-dark-border">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-dark-border">
                        <thead class="bg-gray-50 dark:bg-dark-bg">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Send</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Distributor</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">City</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Phone</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-dark-border">
                            {% for dist in distributors %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-dark-bg/50">
                                <td class="px-4 py-3">
                                    <input type="checkbox" class="dist-checkbox" name="distributor_ids" value="{{ dist.id }}">
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-200">
                                    <div class="font-semibold">{{ dist.business_name }}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">{{ dist.contact_person or '' }}</div>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">{{ dist.city }}</td>
                                <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">{{ dist.phone }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="flex items-center justify-between pt-2">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Tip: Configure WhatsApp in Settings for sending.</p>
                    <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors" onclick="return confirm('Send product availability to selected distributors?');">
                        Send Messages
                    </button>
                </div>
            </form>
        </div>

        <!-- Preview -->
        <div class="bg-white dark:bg-dark-surface rounded-xl shadow-soft dark:shadow-none p-6 border border-gray-100 dark:border-dark-border">
            <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-3">Preview Products</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Top {{ products|length }} active products</p>

            <div class="space-y-3">
                {% for p in products %}
                <div class="p-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg">
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <div class="font-semibold text-gray-900 dark:text-gray-200">{{ p.name }}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">SKU: {{ p.sku }}{% if p.hsn_code %} · HSN: {{ p.hsn_code }}{% endif %}</div>
                        </div>
                        <div class="text-sm font-bold text-gray-900 dark:text-gray-200">₹{{ "%.2f"|format(p.base_price or 0) }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="mt-5">
                <a href="{{ url_for('whatsapp.settings') }}" class="inline-flex items-center text-sm text-primary-600 dark:text-primary-400 hover:underline">Open WhatsApp Settings →</a>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const toggleAll = document.getElementById('toggleAll');
        const checkboxes = () => Array.from(document.querySelectorAll('.dist-checkbox'));

        function allChecked() {
            const boxes = checkboxes();
            return boxes.length > 0 && boxes.every((b) => b.checked);
        }

        function updateToggleText() {
            toggleAll.textContent = allChecked() ? 'Clear all' : 'Select all';
        }

        toggleAll?.addEventListener('click', () => {
            const target = !allChecked();
            checkboxes().forEach((b) => (b.checked = target));
            updateToggleText();
        });

        document.addEventListener('change', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('dist-checkbox')) {
                updateToggleText();
            }
        });

        updateToggleText();
    })();
</script>
{% endblock %}
