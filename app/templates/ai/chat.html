{% extends "base.html" %}

{% block title %}AI Assistant - Mohi Industries ERP{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">AI Assistant</h1>
        <p class="text-gray-600 mt-2">Ask questions about your business data in plain English</p>
    </div>

    {% if not ai_enabled %}
    <!-- Setup Instructions -->
    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-6 rounded mb-6">
        <h2 class="text-xl font-bold text-yellow-800 mb-3">AI Chat Not Configured</h2>
        <p class="text-yellow-700 mb-4">To enable AI chat, you need to add your Groq API key:</p>
        <ol class="list-decimal list-inside text-yellow-700 space-y-2 mb-4">
            <li>Visit <a href="https://console.groq.com/keys" target="_blank" class="underline font-semibold">console.groq.com/keys</a></li>
            <li>Create a free account (no credit card required)</li>
            <li>Generate an API key</li>
            <li>Add to your <code class="bg-yellow-100 px-2 py-1 rounded">.env</code> file: <code class="bg-yellow-100 px-2 py-1 rounded">GROQ_API_KEY=your-key-here</code></li>
            <li>Restart the application</li>
        </ol>
        <p class="text-sm text-yellow-600">Groq is FREE and provides fast AI responses using Llama 3.1</p>
    </div>
    {% endif %}

    <!-- Chat Container -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- Chat Header -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    <span class="text-blue-600 font-bold">AI</span>
                </div>
                <div>
                    <h2 class="font-bold">Mohi AI Assistant</h2>
                    <p class="text-sm text-blue-100">Powered by Llama 3.1</p>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="h-96 overflow-y-auto p-6 space-y-4 bg-gray-50">
            <!-- Welcome Message -->
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-white text-sm">AI</span>
                </div>
                <div class="bg-white rounded-lg p-4 shadow max-w-2xl">
                    <p class="text-gray-800">Hello! I'm your AI assistant. I can help you with:</p>
                    <ul class="mt-2 space-y-1 text-sm text-gray-700">
                        <li>• Finding top customers and sales data</li>
                        <li>• Checking inventory and low stock items</li>
                        <li>• Reviewing pending payments</li>
                        <li>• Analyzing sales trends</li>
                        <li>• Answering business questions</li>
                    </ul>
                    <p class="mt-3 text-gray-600 text-sm">Try asking: "Show me top 5 customers" or "Which products are low in stock?"</p>
                </div>
            </div>
        </div>

        <!-- Suggestions -->
        <div id="suggestions" class="px-6 py-3 bg-gray-100 border-t border-gray-200">
            <p class="text-xs text-gray-600 mb-2">Quick questions:</p>
            <div class="flex flex-wrap gap-2">
                <button onclick="askQuestion('Show me top 5 customers by revenue')" class="text-xs bg-white hover:bg-blue-50 text-blue-600 px-3 py-1 rounded-full border border-blue-200 transition">
                    Top customers
                </button>
                <button onclick="askQuestion('Which products are low in stock?')" class="text-xs bg-white hover:bg-blue-50 text-blue-600 px-3 py-1 rounded-full border border-blue-200 transition">
                    Low stock
                </button>
                <button onclick="askQuestion('What is my total pending payments?')" class="text-xs bg-white hover:bg-blue-50 text-blue-600 px-3 py-1 rounded-full border border-blue-200 transition">
                    Pending payments
                </button>
                <button onclick="askQuestion('Show monthly sales for last 6 months')" class="text-xs bg-white hover:bg-blue-50 text-blue-600 px-3 py-1 rounded-full border border-blue-200 transition">
                    Sales trend
                </button>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 bg-white border-t border-gray-200">
            <form id="chatForm" class="flex space-x-3">
                <input 
                    type="text" 
                    id="userQuery" 
                    placeholder="Ask me anything about your business..." 
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    {% if not ai_enabled %}disabled{% endif %}
                >
                <button 
                    type="submit" 
                    id="sendButton"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed"
                    {% if not ai_enabled %}disabled{% endif %}
                >
                    Send
                </button>
            </form>
        </div>
    </div>

    <!-- Info Box -->
    <div class="mt-6 bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
        <p class="text-sm text-blue-800">
            <strong>Tip:</strong> The AI assistant has access to your current ERP data including customers, orders, products, inventory, and payments. 
            Ask specific questions for better results!
        </p>
    </div>
</div>

<script>
const chatMessages = document.getElementById('chatMessages');
const chatForm = document.getElementById('chatForm');
const userQuery = document.getElementById('userQuery');
const sendButton = document.getElementById('sendButton');
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

// Auto-scroll to bottom
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Add message to chat
function addMessage(content, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-start space-x-3';
    
    if (isUser) {
        messageDiv.classList.add('justify-end');
        messageDiv.innerHTML = `
            <div class="bg-blue-500 text-white rounded-lg p-4 shadow max-w-2xl">
                <p>${content}</p>
            </div>
            <div class="w-8 h-8 bg-gray-500 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-white text-sm">You</span>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-white text-sm">AI</span>
            </div>
            <div class="bg-white rounded-lg p-4 shadow max-w-2xl">
                <div class="prose prose-sm">${content}</div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

// Add loading indicator
function addLoading() {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading';
    loadingDiv.className = 'flex items-start space-x-3';
    loadingDiv.innerHTML = `
        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
            <span class="text-white text-sm">AI</span>
        </div>
        <div class="bg-white rounded-lg p-4 shadow">
            <div class="flex space-x-2">
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        </div>
    `;
    chatMessages.appendChild(loadingDiv);
    scrollToBottom();
}

// Remove loading indicator
function removeLoading() {
    const loading = document.getElementById('loading');
    if (loading) loading.remove();
}

// Format response with markdown-like formatting
function formatResponse(text) {
    // Convert bullet points
    text = text.replace(/^- (.+)$/gm, '<li>$1</li>');
    text = text.replace(/^• (.+)$/gm, '<li>$1</li>');
    
    // Wrap lists
    text = text.replace(/(<li>.*<\/li>)/s, '<ul class="list-disc list-inside space-y-1 mt-2">$1</ul>');
    
    // Convert bold
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    
    // Convert line breaks
    text = text.replace(/\n/g, '<br>');
    
    return text;
}

// Send query to AI
async function sendQuery(query) {
    addMessage(query, true);
    addLoading();
    
    sendButton.disabled = true;
    sendButton.textContent = 'Thinking...';
    
    try {
        const response = await fetch('/ai/api/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ query: query })
        });
        
        const data = await response.json();
        
        removeLoading();
        
        if (data.success) {
            addMessage(formatResponse(data.message));
        } else {
            addMessage(`<p class="text-red-600">Error: ${data.message}</p>`);
        }
    } catch (error) {
        removeLoading();
        addMessage(`<p class="text-red-600">Error: ${error.message}</p>`);
    } finally {
        sendButton.disabled = false;
        sendButton.textContent = 'Send';
    }
}

// Handle form submission
chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const query = userQuery.value.trim();
    if (query) {
        sendQuery(query);
        userQuery.value = '';
    }
});

// Quick question function
function askQuestion(question) {
    userQuery.value = question;
    sendQuery(question);
    userQuery.value = '';
}

// Focus input on load
userQuery.focus();
</script>

<style>
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}
.animate-bounce {
    animation: bounce 1s infinite;
}
</style>
{% endblock %}
