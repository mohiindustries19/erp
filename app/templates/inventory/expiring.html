{% extends "base.html" %}

{% block title %}Expiring Batches - Mohi Industries ERP{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Batches Expiring Soon</h2>
    <p class="text-gray-600 dark:text-gray-400">Batches expiring within the next 30 days - FSSAI Alert</p>
</div>

<div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 dark:bg-red-900/20 dark:border-red-600">
    <div class="flex">
        <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-400 dark:text-red-500" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                    clip-rule="evenodd" />
            </svg>
        </div>
        <div class="ml-3">
            <p class="text-sm text-red-700 dark:text-red-300">
                <strong>FSSAI Compliance Alert:</strong> These batches are approaching expiry. Plan production and sales
                accordingly to minimize waste.
            </p>
        </div>
    </div>
</div>

{% if batches %}
<div
    class="bg-white dark:bg-dark-surface rounded-lg shadow dark:shadow-none border border-transparent dark:border-dark-border">
    <div class="p-6">
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="border-b dark:border-dark-border">
                        <th class="text-left py-3 text-gray-600 dark:text-gray-400 font-semibold">Priority</th>
                        <th class="text-left py-3 text-gray-600 dark:text-gray-400 font-semibold">Batch Number</th>
                        <th class="text-left py-3 text-gray-600 dark:text-gray-400 font-semibold">Product</th>
                        <th class="text-left py-3 text-gray-600 dark:text-gray-400 font-semibold">Mfg Date</th>
                        <th class="text-left py-3 text-gray-600 dark:text-gray-400 font-semibold">Expiry Date</th>
                        <th class="text-left py-3 text-gray-600 dark:text-gray-400 font-semibold">Days Left</th>
                        <th class="text-left py-3 text-gray-600 dark:text-gray-400 font-semibold">Available Qty</th>
                        <th class="text-left py-3 text-gray-600 dark:text-gray-400 font-semibold">Warehouse</th>
                        <th class="text-left py-3 text-gray-600 dark:text-gray-400 font-semibold">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-dark-border">
                    {% for batch in batches %}
                    <tr class="border-b dark:border-dark-border hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors 
                        {% if batch.days_to_expiry() < 0 %}bg-red-100 dark:bg-red-900/30
                        {% elif batch.days_to_expiry() < 7 %}bg-red-50 dark:bg-red-900/10
                        {% elif batch.days_to_expiry() < 15 %}bg-orange-50 dark:bg-orange-900/10
                        {% else %}bg-yellow-50 dark:bg-yellow-900/10{% endif %}">
                        <td class="py-3">
                            {% if batch.days_to_expiry() < 0 %} <span
                                class="px-2 py-1 text-xs rounded bg-red-600 text-white font-bold">EXPIRED</span>
                                {% elif batch.days_to_expiry() < 7 %} <span
                                    class="px-2 py-1 text-xs rounded bg-red-500 text-white font-bold">CRITICAL</span>
                                    {% elif batch.days_to_expiry() < 15 %} <span
                                        class="px-2 py-1 text-xs rounded bg-orange-500 text-white font-bold">HIGH</span>
                                        {% else %}
                                        <span
                                            class="px-2 py-1 text-xs rounded bg-yellow-500 text-white font-bold">MEDIUM</span>
                                        {% endif %}
                        </td>
                        <td class="py-3 font-mono text-sm text-gray-900 dark:text-gray-300">{{ batch.batch_number }}
                        </td>
                        <td class="py-3">
                            <strong class="text-gray-900 dark:text-gray-200">{{ batch.product.name }}</strong><br>
                            <span class="text-xs text-gray-600 dark:text-gray-400">{{ batch.product.sku }}</span>
                        </td>
                        <td class="py-3 text-gray-600 dark:text-gray-400">{{
                            batch.manufacturing_date.strftime('%d-%m-%Y') }}</td>
                        <td class="py-3 text-gray-600 dark:text-gray-400">{{ batch.expiry_date.strftime('%d-%m-%Y') }}
                        </td>
                        <td class="py-3">
                            {% if batch.days_to_expiry() < 0 %} <span class="text-red-600 dark:text-red-400 font-bold">
                                EXPIRED {{ batch.days_to_expiry()|abs }} days ago</span>
                                {% else %}
                                <span
                                    class="{% if batch.days_to_expiry() < 7 %}text-red-600 dark:text-red-400{% elif batch.days_to_expiry() < 15 %}text-orange-600 dark:text-orange-400{% else %}text-yellow-600 dark:text-yellow-400{% endif %} font-bold">
                                    {{ batch.days_to_expiry() }} days
                                </span>
                                {% endif %}
                        </td>
                        <td class="py-3 font-semibold text-gray-900 dark:text-gray-300">{{ batch.quantity_available }}
                            {{ batch.product.unit }}</td>
                        <td class="py-3 text-gray-600 dark:text-gray-400">{{ batch.warehouse.name if batch.warehouse
                            else 'N/A' }}</td>
                        <td class="py-3">
                            {% if batch.days_to_expiry() < 0 %} <button
                                class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-sm font-medium">
                                Remove</button>
                                {% else %}
                                <button
                                    class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium">Allocate</button>
                                {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Summary Stats -->
<div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
    {% set expired_count = namespace(value=0) %}
    {% set critical_count = namespace(value=0) %}
    {% set high_count = namespace(value=0) %}
    {% set medium_count = namespace(value=0) %}

    {% for batch in batches %}
    {% set days = batch.days_to_expiry() %}
    {% if days < 0 %} {% set expired_count.value=expired_count.value + 1 %} {% elif days < 7 %} {% set
        critical_count.value=critical_count.value + 1 %} {% elif days < 15 %} {% set high_count.value=high_count.value +
        1 %} {% else %} {% set medium_count.value=medium_count.value + 1 %} {% endif %} {% endfor %} <div
        class="bg-red-100 dark:bg-red-900/30 rounded-lg p-4 border border-transparent dark:border-red-900/50">
        <p class="text-sm text-red-600 dark:text-red-400">Expired</p>
        <p class="text-2xl font-bold text-red-600 dark:text-red-400">{{ expired_count.value }}</p>
</div>
<div class="bg-red-50 dark:bg-red-900/10 rounded-lg p-4 border border-transparent dark:border-red-900/30">
    <p class="text-sm text-red-600 dark:text-red-400">Critical (< 7 days)</p>
            <p class="text-2xl font-bold text-red-600 dark:text-red-400">{{ critical_count.value }}</p>
</div>
<div class="bg-orange-50 dark:bg-orange-900/10 rounded-lg p-4 border border-transparent dark:border-orange-900/30">
    <p class="text-sm text-orange-600 dark:text-orange-400">High (7-15 days)</p>
    <p class="text-2xl font-bold text-orange-600 dark:text-orange-400">{{ high_count.value }}</p>
</div>
<div class="bg-yellow-50 dark:bg-yellow-900/10 rounded-lg p-4 border border-transparent dark:border-yellow-900/30">
    <p class="text-sm text-yellow-600 dark:text-yellow-400">Medium (15-30 days)</p>
    <p class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ medium_count.value }}</p>
</div>
</div>

{% else %}
<div class="bg-green-50 border-l-4 border-green-500 p-4 dark:bg-green-900/20 dark:border-green-600">
    <div class="flex">
        <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-green-400 dark:text-green-500" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                    clip-rule="evenodd" />
            </svg>
        </div>
        <div class="ml-3">
            <p class="text-sm text-green-700 dark:text-green-300">
                <strong>All Clear!</strong> No batches are expiring in the next 30 days. Great inventory management!
            </p>
        </div>
    </div>
</div>
{% endif %}

<div class="mt-6 flex justify-between">
    <a href="{{ url_for('inventory.list_batches') }}"
        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded">
        ‚Üê View All Batches
    </a>
    <a href="{{ url_for('main.dashboard') }}" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded">
        Back to Dashboard
    </a>
</div>
{% endblock %}