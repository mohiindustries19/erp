{% extends "base.html" %}

{% block title %}Inventory Optimization - Mohi Industries ERP{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Inventory Optimization</h1>
            <p class="text-gray-600 mt-2">AI-powered recommendations for optimal stock levels</p>
        </div>
        <a href="{{ url_for('advanced_analytics.dashboard') }}" 
           class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition">
            Back to Analytics
        </a>
    </div>

    <!-- Loading State -->
    <div id="loading" class="bg-white rounded-lg shadow p-12 text-center">
        <div class="text-sm text-gray-500 mb-4">Loading...</div>
        <p class="text-gray-600">Analyzing inventory levels and sales patterns...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden bg-red-50 border-l-4 border-red-500 p-6 rounded">
        <p class="text-red-800" id="errorMessage"></p>
    </div>

    <!-- Results -->
    <div id="results" class="hidden">
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-600 text-sm">Total Products</p>
                <p class="text-2xl font-bold text-gray-800 mt-1" id="totalProducts">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-600 text-sm">Critical Stock</p>
                <p class="text-2xl font-bold text-red-600 mt-1" id="criticalCount">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-600 text-sm">Low Stock</p>
                <p class="text-2xl font-bold text-yellow-600 mt-1" id="lowCount">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-600 text-sm">Overstocked</p>
                <p class="text-2xl font-bold text-blue-600 mt-1" id="overstockedCount">-</p>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b">
                <div class="flex space-x-1 p-4">
                    <button onclick="filterStatus('all')" 
                            class="status-tab px-4 py-2 rounded transition bg-blue-500 text-white" 
                            data-status="all">
                        All Products
                    </button>
                    <button onclick="filterStatus('Critical')" 
                            class="status-tab px-4 py-2 rounded transition text-gray-700 hover:bg-gray-100" 
                            data-status="Critical">
                        Critical
                    </button>
                    <button onclick="filterStatus('Low')" 
                            class="status-tab px-4 py-2 rounded transition text-gray-700 hover:bg-gray-100" 
                            data-status="Low">
                        Low Stock
                    </button>
                    <button onclick="filterStatus('Overstocked')" 
                            class="status-tab px-4 py-2 rounded transition text-gray-700 hover:bg-gray-100" 
                            data-status="Overstocked">
                        Overstocked
                    </button>
                </div>
            </div>
        </div>

        <!-- Recommendations Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-6 border-b">
                <h2 class="text-xl font-bold text-gray-800">Inventory Recommendations</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">SKU</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Current Stock</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reorder Level</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Recommended Order</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                        </tr>
                    </thead>
                    <tbody id="recommendationsTable" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
let allRecommendations = [];

function loadRecommendations() {
    fetch('/advanced-analytics/api/inventory-optimization')
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading').classList.add('hidden');
            
            if (!data.success) {
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = data.error;
                return;
            }
            
            allRecommendations = data.data.recommendations;
            displayRecommendations(data.data);
        })
        .catch(error => {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = 'Failed to load recommendations: ' + error.message;
        });
}

function displayRecommendations(data) {
    document.getElementById('results').classList.remove('hidden');
    
    // Update summary cards
    document.getElementById('totalProducts').textContent = data.total_products;
    document.getElementById('criticalCount').textContent = data.critical_count;
    document.getElementById('lowCount').textContent = data.low_count;
    document.getElementById('overstockedCount').textContent = data.overstocked_count;
    
    // Display all recommendations
    renderTable(data.recommendations);
}

function renderTable(recommendations) {
    const tbody = document.getElementById('recommendationsTable');
    tbody.innerHTML = '';
    
    recommendations.forEach(rec => {
        const statusColor = rec.status === 'Critical' ? 'red' : 
                           rec.status === 'Low' ? 'yellow' : 
                           rec.status === 'Overstocked' ? 'blue' : 'green';
        
        tbody.innerHTML += `
            <tr>
                <td class="px-6 py-4 text-sm font-medium text-gray-900">${rec.product_name}</td>
                <td class="px-6 py-4 text-sm text-gray-600">${rec.sku}</td>
                <td class="px-6 py-4 text-sm">
                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                        ${rec.status}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-900">${rec.current_stock}</td>
                <td class="px-6 py-4 text-sm text-gray-600">${rec.reorder_level}</td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900">${rec.recommended_order}</td>
                <td class="px-6 py-4 text-sm text-gray-600">${rec.action}</td>
            </tr>
        `;
    });
}

function filterStatus(status) {
    // Update tab styles
    document.querySelectorAll('.status-tab').forEach(tab => {
        if (tab.dataset.status === status) {
            tab.className = 'status-tab px-4 py-2 rounded transition bg-blue-500 text-white';
        } else {
            tab.className = 'status-tab px-4 py-2 rounded transition text-gray-700 hover:bg-gray-100';
        }
    });
    
    // Filter recommendations
    const filtered = status === 'all' ? 
        allRecommendations : 
        allRecommendations.filter(r => r.status === status);
    
    renderTable(filtered);
}

// Load recommendations on page load
window.addEventListener('load', () => {
    loadRecommendations();
});
</script>
{% endblock %}
